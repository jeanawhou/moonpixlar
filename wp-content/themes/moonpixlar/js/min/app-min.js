function setActiveStyle(styleName,value,object){if(object=object||canvas.getActiveObject()){if(object.setSelectionStyles&&object.isEditing){var style={};style[styleName]=value,object.setSelectionStyles(style),object.setCoords()}else object[styleName]=value;object.setCoords(),canvas.renderAll()}}function getActiveStyle(styleName,object){return object=object||canvas.getActiveObject(),object?object.getSelectionStyles&&object.isEditing?object.getSelectionStyles()[styleName]||"":object[styleName]||"":""}function removeSelectedObject(){var activeObject=canvas.getActiveObject();canvas.remove(activeObject)}var canvas,imageObj=new Image,textarea=null,selectedFont=null,selectedColor="#ffff00",imageWidth,imageHeight;window.addEventListener("load",function onLoad(){function showUploadedItem(source){var list=document.getElementById("image-list"),li=document.createElement("li"),img=document.createElement("img");img.src=source,li.appendChild(img),list.appendChild(li)}function displayCanvasContent(result){fabric.Image.fromURL(result.image,function(oImg){canvas.add(oImg),oImg.selectable=!1,oImg.scaleToWidth(500);for(var i in result.texts)addTextOnCanvas(result.texts[i])})}function addTextOnCanvas(textObj){WebFont.load({google:{families:[textObj.fontFamily]},active:function(){var textSample=new fabric.IText(textObj.text,{left:textObj.left,top:textObj.top,fontFamily:textObj.fontFamily,fill:textObj.color,fontSize:textObj.fontSize,fontWeight:textObj.fontWeight,originX:textObj.halign,hasRotatingPoint:!0,centerTransform:!0});canvas.add(textSample),canvas.renderAll()}})}canvas=new fabric.Canvas("canvas");var input=document.getElementById("imgUpload"),formdata=!1;window.FormData&&(formdata=new FormData,$("#imgUpload").removeClass("hidden"),document.getElementById("btn").style.display="none"),input.addEventListener("change",function(evt){for(var i=0,len=this.files.length,img,reader,file;len>i;i++)file=this.files[i],file.type.match(/image.*/)&&(window.FileReader&&(reader=new FileReader,reader.onloadend=function(e){}),formdata&&formdata.append("images[]",file));formdata&&$.ajax({url:"upload.php",type:"POST",data:formdata,processData:!1,contentType:!1,success:function(res){fabric.Image.fromURL("uploadedImages/"+res,function(oImg){canvas.add(oImg)})}})},!1),$(document).on("click","#invitations .thumbnail img",function(){canvas.clear(),$.ajax({type:"POST",url:"templates/"+$(this).parent().attr("data-json"),contentType:"application/json; charset=utf-8",dataType:"json",async:!0,cache:!1}).done(function(result){displayCanvasContent(result)})}),$(document).on("click","#myfiles .thumbnail img",function(e){fabric.Image.fromURL($(this).attr("src"),function(oImg){canvas.add(oImg)})}),$(document).on("click","#saveBtn",function(){var activeObject=canvas.getActiveObject();activeObject&&(activeObject.hasBorders=activeObject.hasControls=!1),$("#textSettings").addClass("hidden"),canvas.renderAll();var theImage=document.getElementById("canvas").toDataURL("image/png");setTimeout(function(){$.ajax({type:"POST",url:"saveimage.php",data:{imgBase64:theImage}}).done(function(o){console.log("saved")})},3e3)}),$(document).on("click","#addTextBtn",function(){var textObj=new Object;textObj.text="Enter Your Text",textObj.left=50,textObj.top=50,console.log(" .....      "+selectedColor),textObj.color=selectedColor,null==selectedFont&&(selectedFont="Arial"),textObj.fontFamily=selectedFont,textObj.fontSize=40,textObj.fontWeight="normal",textObj.halign="left",addTextOnCanvas(textObj)}),$(document).on("click","#textSettings button#remove",function(e){removeSelectedObject(),$("#textSettings").addClass("hidden")}),$(document).on("click","#textSettings button#copy",function(e){var o=fabric.util.object.clone(canvas.getActiveObject());o.set("top",o.top+5),o.set("left",o.left+5),canvas.add(o),$("#textSettings").addClass("hidden")}),$(document).on("change","#opacityControl",function(e){setActiveStyle("opacity",parseInt(e.target.value,10)/100)}),$(document).on("change","#colorControl",function(e){selectedColor=e.target.value,console.log(selectedColor),setActiveStyle("fill",e.target.value)}),$(document).on("change","#fSizeControl",function(e){setActiveStyle("fontSize",e.target.value)}),$(document).on("change","#font-family",function(e){selectedFont=e.target.value,WebFont.load({google:{families:[e.target.value]},active:function(){setActiveStyle("fontFamily",e.target.value)}})}),$(document).on("click",".text-alignment .align ",function(e){e.preventDefault(),$(".align").removeClass("active"),$(this).addClass("active"),setActiveStyle("originX",$(this).attr("data-align"))}),$(document).on("click",".text-styling .formating ",function(e){switch(e.preventDefault(),$(this).removeClass("active"),$(this).attr("data-style")){case"italic":$(this).addClass("italic"===getActiveStyle("fontStyle")?"":"active"),setActiveStyle("fontStyle","italic"===getActiveStyle("fontStyle")?"":"italic");break;case"bold":$(this).addClass("bold"===getActiveStyle("fontWeight")?"":"active"),setActiveStyle("fontWeight","bold"===getActiveStyle("fontWeight")?"":"bold");break;case"underline":$(this).addClass("underline"===getActiveStyle("textDecoration")?"":"active"),setActiveStyle("textDecoration","underline"===getActiveStyle("textDecoration")?"":"underline")}}),$(document).on("click","#saveDesignBtn",function(e){console.log(JSON.stringify(canvas)),$.ajax({type:"POST",url:"savedesign.php",dataType:"json",data:{json:JSON.stringify(canvas)}})}),$(document).on("click","#loadDesignBtn",function(e){var jsonUrl="userDesigns/design1.json";$.getJSON(jsonUrl,{format:"json"}).done(function(data){var fArray=[];$.each(data.objects,function(key,value){"undefined"!=typeof value.fontFamily&&(fArray.push(value.fontFamily),WebFont.load({google:{families:[value.fontFamily]},active:function(){}}))}),setTimeout(function(){canvas.loadFromJSON(JSON.stringify(data),function(){canvas.renderAll()})},3e3)})}),canvas.on("mouse:up",function(options){options.target&&("i-text"==options.target.type?($("#textSettings").removeClass("hidden"),$("#textSettings").css("left",options.target.left+options.target.width+10),$("#textSettings").css("top",options.target.top),console.log(getActiveStyle("originX")),$("#font-family").val(getActiveStyle("fontFamily")),$("#colorControl").val(getActiveStyle("fill")),$("#fSizeControl").val(getActiveStyle("fontSize")),$("#opacityControl").val(100*getActiveStyle("opacity")),$(".formating.bold, .formating.italic, .formating.underline").removeClass("active"),$(".formating.bold").addClass("bold"===getActiveStyle("fontWeight")?"active":""),$(".formating.italic").addClass("italic"===getActiveStyle("fontStyle")?"active":""),$(".formating.underline").addClass("underline"===getActiveStyle("textDecoration")?"active":""),$(".align").removeClass("active"),$('.align[data-align="'+getActiveStyle("originX")+'"]').addClass("active")):$("#textSettings").addClass("hidden"))}),canvas.on("mouse:down",function(options){$("#textSettings").addClass("hidden")}),window.onkeydown=function(event){console.log(event.which);var obj=canvas.getActiveObject(),leftPos=obj.getLeft(),topPos=obj.getTop();switch($("#textSettings").addClass("hidden"),event.which){case 37:obj.setLeft(parseInt(leftPos)-5).setCoords();break;case 38:obj.setTop(parseInt(topPos)+5).setCoords();break;case 39:obj.setLeft(parseInt(leftPos)+5).setCoords();break;case 40:obj.setTop(parseInt(topPos)-5).setCoords();break;case 46:removeSelectedObject()}canvas.renderAll()}});