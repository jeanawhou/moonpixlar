var canvas,imageObj=new Image,textarea=null,selectedFont=null,imageWidth,imageHeight,canvasWidth=600,canvasHeight=600,grid=40,saveFormat="png",selectedThemeId=-1,projectID,selectedBookCanvas,projectType="other",queries={};$.each(document.location.search.substr(1).split("&"),function(a,e){var t=e.split("=");t.length>1&&(queries[t[0].toString()]=t[1].toString())}),queries.cw&&(canvasWidth=queries.cw),queries.ch&&(canvasHeight=queries.ch),queries.pid&&(projectID=queries.pid),queries.type&&(projectType=queries.type),console.log("....... "+projectType),window.addEventListener("load",function a(){var e="#ffff00",t="#000000",n="2514829-69a8422361a1b4a8073fe1981",o=!1;window.FormData&&(formdata=new FormData,$("#imgUpload").removeClass("hidden"),document.getElementById("imgUploadbtn").style.display="none"),window.canvaApp=function(a){if(!a.container)throw new Error("Container not defined.");var n=this,o=$("#main"),s=o.find("#leftTools"),i=o.find("#workspace"),c=o.find("#leftToolsContent");Object.defineProperties(this,{$container:{value:o,writable:!1},$leftTools:{value:s,writable:!1},$workSpace:{value:i,writable:!1},$leftToolsContent:{value:c,writable:!1}}),n.setSelectedColor=function(a){e=a},n.getSelectedColor=function(){return e},n.setTextShadowColor=function(a){t=a},n.getTextShadowColor=function(){return t},n.setItemShadow=function(){var a={color:"#000000",blur:20,offsetX:10,offsetY:10,opacity:1,fillShadow:!0,strokeShadow:!0};return a},"bookCover"==projectType?(n.initBookCanvas(),$(".canvas_holder").hide(),$(".book_canvas_holder").show(),n.manageBookCoverWindow()):(n.init(),$(".book_canvas_holder").hide(),$(".canvas_holder").show(),n.manageEditorWindow())},canvaApp.prototype.manageBookCoverWindow=function(){var a=this,e=parseInt($(".editor_window").width()),t=parseInt($(".editor_window").height()),n=1300,o=750,s=$(".bookCanvasHolder"),i=parseInt($(".bookCanvasHolder").width());console.log($(".bookCanvasHolder").width());var c;c=o>t-60?(t-30)/o:1,console.log("ratio   "+c);var c=1,r=parseInt((e-n)/2+170),l=parseInt((t-o)/2);return;if(s.css({zoom:c,position:"absolute",left:r,top:l}),o>t-30)var c=(t-30)/o;else c=1;var i=parseInt($(".bookCanvasHolder").width())*c,d=parseInt($(".bookCanvasHolder").height())*c},canvaApp.prototype.manageEditorWindow=function(){var a=this,e=$(".editor_window").width(),t=$(".editor_window").height(),n=a.$canvas.width,o=a.$canvas.height,s=$(".canvas-container"),i;if(i=n>e-30?(e-30)/n:1,s.css({transform:"scale("+i+")"}),o>t-30)var i=(t-30)/o;else i=1;s.css({transform:"scale("+i+")",position:"absolute"});var c=$(".canvas-container")[0].getBoundingClientRect().width,r=$(".canvas-container")[0].getBoundingClientRect().height,l=parseInt(e)/2-parseInt(c)/2,d=parseInt(t)/2-parseInt(r)/2;s.css({left:l,top:d})},canvaApp.prototype._configure=function(){var a=this;$bgColorSelectionList=a.$container.find(".predefined-colors"),$.each(["#f00","#ff0","#0f0","#0ff","#00f","#f0f","#000","#fff"],function(){$bgColorSelectionList.append("<div class='color' data-color='"+this+"' style='background: "+this+"; color: "+this+";' ></div>")}),a.bindEvents(),"user"==queries.ttype&&a.getProject()},canvaApp.prototype._configureBookCanvas=function(){var a=this;$bgColorSelectionList=a.$container.find(".predefined-colors"),$.each(["#f00","#ff0","#0f0","#0ff","#00f","#f0f","#000","#fff"],function(){$bgColorSelectionList.append("<div class='color' data-color='"+this+"' style='background: "+this+"; color: "+this+";' ></div>")}),a.bindEvents(),"user"==queries.ttype},canvaApp.prototype.bindEvents=function(){var a=this,e=a.$container;e.find(".predefined-colors").on("click",".color",function(e){a.setBackgroundColor($(this).attr("data-color"))}),e.find(".add-color").colorpicker({container:!0,align:"left"}).on("changeColor",function(t){e.find(".add-color").css("background",t.color.toHex()),a.setBackgroundColor(t.color.toHex())}),e.find(".bg-list").on("click","a",function(e){e.preventDefault(),a.setBackgroundImage($(this).attr("data-image"))}),e.find("#text-designs").on("click",".text",function(e){a.addText($(this).attr("data-texttype"),$(this).attr("data-text"))}),e.find("#images").on("click",".thumbnail",function(e){a.addImage($(this).attr("data-image"))}),e.find("#leftTools").on("click",".clone-item",function(e){e.preventDefault(),a.cloneSelectedItem()}),e.find("#leftTools").on("click",".delete-item",function(e){e.preventDefault(),a.removeSelectedObject()}),e.find("#leftTools").on("click",".formating ",function(e){e.preventDefault(),a.setTextFormating($(this).attr("data-style"),this)}),e.find("#leftTools").on("click",".align ",function(e){e.preventDefault(),$(".align").removeClass("active"),$(this).addClass("active");var t,n=a.$canvas.getActiveObject().width;"left"==$(this).attr("data-align")?t=n/2:"right"==$(this).attr("data-align")?t=a.$canvas.width-n/2:"center"==$(this).attr("data-align")&&(t=a.$canvas.width/2),a.$canvas.getActiveObject().alignment=$(this).attr("data-align"),a.$canvas.getActiveObject().set("left",t).setCoords(),a.$canvas.renderAll()}),e.find("#leftTools").on("click",".rotation-icon ",function(e){e.preventDefault(),$(".rotation-icon").removeClass("active"),$(this).addClass("active"),a.$canvas.getActiveObject().set("angle",$(this).attr("data-rotation")).setCoords(),a.$canvas.renderAll()}),e.find("#textSettings").on("click",".opacity-icon ",function(e){e.preventDefault(),$(".opacity-icon").removeClass("active"),$(this).addClass("active"),a.setActiveStyle("opacity",parseInt($(this).attr("data-opacity"),10)/100),a.$canvas.renderAll()}),e.find("#leftTools").on("click",".send-backward",function(e){a.$canvas.getActiveObject().sendBackwards()}),e.find("#leftTools").on("click",".bring-forward",function(e){a.$canvas.getActiveObject().bringForward()}),e.find("#leftTools").on("click",".send-to-back",function(e){a.$canvas.getActiveObject().sendToBack()}),e.find("#leftTools").on("click",".bring-to-front",function(e){a.$canvas.getActiveObject().bringToFront()}),e.find("#textSettings").on("change","#colorControl",function(e){a.setSelectedColor=e.target.value,a.setActiveStyle("fill",e.target.value)}),e.find("#textSettings").on("change","#fSizeControl",function(e){a.setActiveStyle("fontSize",e.target.value)}),e.find("#textSettings").on("change","#font-family",function(e){WebFont.load({google:{families:[e.target.value]},active:function(){a.setActiveStyle("fontFamily",e.target.value)}})}),e.find("#textSettings").on("change",".object-shadow",function(){console.log("shadow change event"),console.log(this.checked),a.manageObjectShadow(this,"#textSettings")}),e.find("#image-settings").on("change",".object-shadow",function(){a.manageObjectShadow(this,"#image-settings")}),e.find("#textSettings").on("change",".shadow-distance",function(e){a.manageShadowDistance(e.target.value)}),e.find("#image-settings").on("change",".shadow-distance",function(e){a.manageShadowDistance(e.target.value)}),e.find("#textSettings").on("change",".shadowColorControl",function(e){a.manageShadowColor(e.target.value)}),e.find("#image-settings").on("change",".shadowColorControl",function(e){a.manageShadowColor(e.target.value)}),canvaApp.prototype.manageShadowColor=function(a){var e=this,t=e.$canvas.getActiveObject().getShadow();t.color=a,e.$canvas.getActiveObject().setShadow(t),e.$canvas.renderAll()},canvaApp.prototype.manageObjectShadow=function(a,e){var t=this,n={};a.checked?(n=t.setItemShadow(),$(e+" .shadow-distance-container,"+e+" .shadowColorControl").removeClass("hidden")):(n="",$(e+" .shadow-distance-container,"+e+" .shadowColorControl").addClass("hidden")),t.$canvas.getActiveObject().setShadow(n),t.$canvas.renderAll()},canvaApp.prototype.manageShadowDistance=function(a){var e=this,t=e.$canvas.getActiveObject().getShadow();t.offsetY=t.offsetX=parseInt(a),e.$canvas.getActiveObject().setShadow(t),e.$canvas.renderAll()},e.find("#leftTools").on("click",".increase",function(e){a.manageObjectPosition("increase",$(this).parent().attr("data-position"),0)}),e.find("#leftTools").on("click",".decrease",function(e){a.manageObjectPosition("decrease",$(this).parent().attr("data-position"),0)}),e.find("#leftTools").on("keyup",".object-position",function(e){a.manageObjectPosition("with-input",$(this).parent().attr("data-position"),$(this).val())}),e.find("#leftTools").on("change","#img-opacity,#shape-opacity",function(e){a.setActiveStyle("opacity",parseInt(e.target.value,10)/100),a.$canvas.renderAll()}),e.find(".shapes-list,.shapes-list1").on("click",".shape",function(e){e.preventDefault(),a.loadSelectedShape($(this).attr("data-image"))}),e.find(".themes-list").on("click",".theme",function(e){e.preventDefault(),selectedThemeId=$(this).attr("data-id"),$("#update-theme-btn")&&$("#update-theme-btn").removeClass("hidden"),$("#save-theme-btn")&&$("#save-theme-btn").addClass("hidden"),a.getTheme($(this).attr("data-id"))}),e.find(".my-projects-list").on("click",".myproject",function(e){e.preventDefault(),projectID=$(this).attr("data-id"),a.getProject()}),e.find(".basic-shapes").on("click",".shape",function(e){e.preventDefault(),a.loadSelectedShape($(this).attr("data-image"))}),e.find("#backgrounds .search-container").on("click",".btn",function(e){a.manageSearch("background",$("#backgrounds .search-container .search-key").val(),"#backgrounds",".backgrounds-list",".search-backgrounds-list",1)}),e.find("#images .search-container").on("click",".btn",function(e){$(".search-images-list").attr("data-page",1),a.manageSearch("images",$("#images .search-container .search-key").val(),"#images",".masonry",".search-images-list",1)}),e.find(".search-container").on("click",".fa-long-arrow-left",function(a){$(this).parents("#images").length>0&&($(".search-images-list .mCSB_container").html(""),$(".images-list").removeClass("hidden"),$("#images .search-container .search-key").val(""),$("#images .search-container .fa-long-arrow-left").addClass("hidden")),$(this).parents("#backgrounds").length>0&&($(".search-backgrounds-list .mCSB_container").html(""),$(".backgrounds-list").removeClass("hidden"),$("#backgrounds .search-container .search-key").val(""),$("#backgrounds .search-container .fa-long-arrow-left").addClass("hidden"))}),e.find(".upload-image-form").on("change","#imgUpload",function(e){$(".loading-container").removeClass("hidden");for(var t=0,n=this.files.length,o,s,i;t<n;t++)i=this.files[t],i.type.match(/image.*/)&&(window.FileReader&&(s=new FileReader,s.onloadend=function(a){}),formdata&&formdata.append("images[]",i));formdata&&$.ajax({crossDomain:!0,url:globalarr.site_url+"/wp-content/themes/moonpixlar/upload.php",type:"POST",data:formdata,processData:!1,contentType:!1,async:!1,success:function(e){fabric.Image.fromURL(globalarr.site_url+"/wp-content/themes/moonpixlar/uploadedImages/"+e,function(e){console.log(e.width+"     "+a.$canvas.width),console.log(e.height+"     "+a.$canvas.height),e.width>a.$canvas.width&&e.scaleToWidth(a.$canvas.width),e.height>a.$canvas.height&&e.scaleToHeight(a.$canvas.height),a.$canvas.centerObject(e),a.$canvas.add(e),a.$canvas.renderAll(),$(".loading-container").addClass("hidden")})},error:function(a){}})}),e.find('a[data-toggle="tab"]').on("shown.bs.tab",function(t){"shapes"==$(this).attr("aria-controls")?a.loadShapes():"themes"==$(this).attr("aria-controls")?a.loadThemes():"myProjects"==$(this).attr("aria-controls")&&a.loadProjects(".my-projects-list"),$(".settings-panel").addClass("hidden"),e.find(".tab-pane").removeClass("hidden")}),e.find(".mask-images li").on("click",function(e){var t=$(this).find("img").attr("src");a.manageMask(t)}),$("#snap-btn").on("click",function(a){$(this).toggleClass("active")}),$("#grid-btn").on("click",function(e){if($(this).hasClass("active"))$(this).removeClass("active"),a.hideGrid();else{$(this).addClass("active");var t=parseInt(jQuery("#grid-size").val())||40;t>a.$canvas.width/2&&(t=a.$canvas.width/2),a.showGrid(t)}}),$("#save-theme-btn").on("click",function(e){$(".loading-container").removeClass("hidden");var t=Array("width","height","orig_src","clip_left","clip_top","clip_width","clip_height","is_frame","id","gradientAngle"),n=JSON.stringify(a.$canvas.toJSON(t)),o=a.$canvas.toDataURL("image/jpeg");$.ajax({url:globalarr.site_url+"/wp-json/save-theme/post",type:"post",data:{theme_name:$("#projectName").val(),theme_width:a.$canvas.width,theme_height:a.$canvas.height,theme_tag:$("#projectTag").val(),theme_image:o,json_object:JSON.stringify(a.$canvas)},success:function(a,e){$(".loading-container").addClass("hidden")},error:function(a,e,t){}})}),$(".save-project-btn").on("click",function(e){$(".loading-container").removeClass("hidden"),a.saveProject()}),$("#update-theme-btn").on("click",function(e){a.updateTheme()}),$("#shapes .covers-btn").on("click",function(e){a.loadProjects(".covers-list"),$("#shapes .btn-group button").removeClass("active"),$(this).addClass("active"),$(".shapes-list").addClass("hidden"),$(".covers-list").removeClass("hidden"),$(".effects-list").addClass("hidden")}),$("#shapes .shapes-btn").on("click",function(e){a.loadShapes(),$("#shapes .btn-group button").removeClass("active"),$(this).addClass("active"),$(".shapes-list").removeClass("hidden"),$(".covers-list").addClass("hidden"),$(".effects-list").addClass("hidden")}),$("#shapes .effects-btn").on("click",function(e){a.loadEffects(),$("#shapes .btn-group button").removeClass("active"),$(this).addClass("active"),$(".shapes-list").addClass("hidden"),$(".covers-list").addClass("hidden"),$(".effects-list").removeClass("hidden")}),$("#backgrounds").on("scroll",function(e){var t=parseInt($("#backgrounds").prop("scrollHeight")),n=parseInt($(this).scrollTop()),o=parseInt($(this).height());if(o+n==t-10){console.log($(this).scrollTop()+"     "+$(this).height()+"  "+$("#backgrounds").prop("scrollHeight"));var s=parseInt($(".search-backgrounds-list").attr("data-page"));s+=1,$(".search-backgrounds-list").attr("data-page",s),a.manageSearch("background",$("#backgrounds .search-container .search-key").val(),"#backgrounds",".backgrounds-list",".search-backgrounds-list",s)}}),$("#images").on("scroll",function(e){var t=parseInt($("#images").prop("scrollHeight")),n=parseInt($(this).scrollTop()),o=parseInt($(this).height());if(o+n==t-10){var s=parseInt($(".search-images-list").attr("data-page"));s+=1,$(".search-images-list").attr("data-page",s),a.manageSearch("images",$("#images .search-container .search-key").val(),"#images",".masonry",".search-images-list",s)}}),a.$canvas.on("object:moving",function(e){$("#snap-btn").hasClass("active")&&a.snapObjects(e)}),a.$canvasFrontCover.on("mouse:down",function(e){selectedBookCanvas=a.$canvasFrontCover,a.$canvas=a.$canvasFrontCover}),a.$canvasBackCover.on("mouse:down",function(e){selectedBookCanvas=a.$canvasBackCover,a.$canvas=a.$canvasBackCover}),a.$canvasSpine.on("mouse:down",function(e){selectedBookCanvas=a.$canvasSpine,a.$canvas=a.$canvasSpine}),a.$canvas.on("mouse:down",function(t){switch(console.log(this),t.target&&t.target.type){case"i-text":e.find(".settings-panel").addClass("hidden"),e.find("#textSettings").removeClass("hidden"),e.find(".tab-pane").addClass("hidden"),a.showTextSettings();break;case"image":e.find(".settings-panel").addClass("hidden"),e.find("#image-settings").removeClass("hidden"),e.find(".tab-pane").addClass("hidden"),a.updateImageSettings();break;case"path-group":case"group":a.showShapeSettings(t.target);break;default:e.find(".settings-panel").addClass("hidden"),e.find(".tab-pane").removeClass("hidden")}})},canvaApp.prototype.init=function(){var a=this;a.$canvas=new fabric.Canvas("canvas"),a.$canvas.setHeight(canvasHeight),a.$canvas.setWidth(canvasWidth),a._configure()},canvaApp.prototype.initBookCanvas=function(){var a=this;a.$canvasFrontCover=new fabric.Canvas("canvasFrontCover"),a.$canvasBackCover=new fabric.Canvas("canvasBackCover"),a.$canvasSpine=new fabric.Canvas("canvasSpine"),selectedBookCanvas=a.$canvasFrontCover,a.$canvas=a.$canvasFrontCover,a._configureBookCanvas()},canvaApp.prototype.setBackgroundColor=function(a){var e=this;e.$canvas.backgroundImage=0,e.$canvas.setBackgroundColor(a),e.$canvas.renderAll()},canvaApp.prototype.setBackgroundImage=function(a){var e=this;fabric.Image.fromURL(a,function(a){a.set({originX:"left",originY:"top"});var t=parseInt(e.$canvas.width)/parseInt(a.getWidth());a.scale(t),e.$canvas.getHeight()>a.getHeight()&&a.scaleToHeight(e.$canvas.getHeight()),a.left=(e.$canvas.getWidth()-a.getWidth())/2,a.top=(e.$canvas.getHeight()-a.getHeight())/2,e.$canvas.setBackgroundImage(a,e.$canvas.renderAll.bind(e.$canvas))},{crossOrigin:"Anonymous"})},canvaApp.prototype.addText=function(a,e){var t=this,n;n="big"==a?36:"medium"==a?22:16;var o=new fabric.IText(e,{originX:"center",originY:"center",fontFamily:"Open Sans",fontSize:n,fill:"#ccc",fontWeight:"bold"});o.left=t.$canvas.width/2-o.width/2,o.top=t.$canvas.height/2-o.height/2;var s={color:"rgba(0,0,0,0.6)",blur:20,offsetX:10,offsetY:10,opacity:.6,fillShadow:!0,strokeShadow:!0};t.$canvas.add(o)},canvaApp.prototype.addImage=function(a){var e=this;fabric.Image.fromURL(a,function(a){console.log(a.width+"     "+e.$canvas.width),console.log(a.height+"     "+e.$canvas.height),a.width>e.$canvas.width&&a.scaleToWidth(e.$canvas.width),a.height>e.$canvas.height&&a.scaleToHeight(e.$canvas.height),e.$canvas.centerObject(a),e.$canvas.add(a),e.$canvas.renderAll()},{crossOrigin:"Anonymous"})},canvaApp.prototype.cloneSelectedItem=function(){var a=this,e=a.$canvas.getActiveObject();e&&(fabric.util.getKlass(e.type).async?e.clone(function(t){t.set({left:e.left+20,top:e.top+20}),a.$canvas.add(t)}):a.$canvas.add(e.clone().set({left:e.left+20,top:e.top+20})),a.$canvas.renderAll())},canvaApp.prototype.removeSelectedObject=function(){var a=this,e=a.$canvas.getActiveObject();a.$canvas.remove(e)},canvaApp.prototype.setTextFormating=function(a,e){var t=this;switch(a){case"italic":t.manageClassOnTextProps(e),t.setActiveStyle("fontStyle","italic"===t.getActiveStyle("fontStyle")?"":"italic");break;case"bold":t.manageClassOnTextProps(e),t.setActiveStyle("fontWeight","bold"===t.getActiveStyle("fontWeight")?"":"bold");break;case"underline":t.manageClassOnTextProps(e),t.setActiveStyle("textDecoration","underline"===t.getActiveStyle("textDecoration")?"":"underline")}},canvaApp.prototype.manageClassOnTextProps=function(a){var e=this;$(a).hasClass("active")?$(a).removeClass("active"):$(a).addClass("active")},canvaApp.prototype.setActiveStyle=function(a,e,t){var n=this;if(t=t||n.$canvas.getActiveObject()){if(t.setSelectionStyles&&t.isEditing){var o={};o[a]=e,t.setSelectionStyles(o),t.setCoords()}else t[a]=e;t.setCoords(),n.$canvas.renderAll()}},canvaApp.prototype.getActiveStyle=function(a,e){var t=this;return e=e||t.$canvas.getActiveObject(),e?e.getSelectionStyles&&e.isEditing?e.getSelectionStyles()[a]||"":e[a]||"":""},canvaApp.prototype.updateImageSettings=function(){var a=this;$("#image-settings #object-x-position").val(a.$canvas.getActiveObject().left),$("#image-settings #object-y-position").val(a.$canvas.getActiveObject().top);var e=a.$canvas.getActiveObject().getShadow();e&&$("#img-shadow").bootstrapSlider("setValue",parseInt(e.offsetX)).change()},canvaApp.prototype.showTextSettings=function(){var a=this;"bold"===a.getActiveStyle("fontWeight")?$(".formating.bold").addClass("active"):$(".formating.bold").removeClass("active"),"italic"===a.getActiveStyle("fontStyle")?$(".formating.italic").addClass("active"):$(".formating.italic").removeClass("active"),"underline"===a.getActiveStyle("textDecoration")?$(".formating.underline").addClass("active"):$(".formating.underline").removeClass("active"),"Helvetica"!=a.getActiveStyle("fontFamily")&&$("#font-family").val(a.getActiveStyle("fontFamily")).change(),$("#fSizeControl").bootstrapSlider("setValue",parseInt(a.getActiveStyle("fontSize"))).change();var e=a.$canvas.getActiveObject().getShadow();e&&($("#textSettings #shadow-distance-text").bootstrapSlider("setValue",parseInt(e.offsetX)).change(),$("#textSettings #shadowColorControl").val(e.color)),$("#textSettings #colorControl").val(a.getActiveStyle("fill"));var t=a.getActiveStyle("opacity");t*=100,$("#textSettings .opacity-icon").removeClass("active"),$("#textSettings .opacity-icon[data-opacity='"+t+"']").addClass("active");var n=a.$canvas.getActiveObject().alignment;$("#textSettings .align").removeClass("active"),$("#textSettings .align[data-align='"+n+"']").addClass("active")},canvaApp.prototype.manageObjectPosition=function(a,e,t){var n=this;switch("increase"==a?n.$canvas.getActiveObject()[e]=n.$canvas.getActiveObject()[e]+5:"decrease"==a?n.$canvas.getActiveObject()[e]=n.$canvas.getActiveObject()[e]-5:n.$canvas.getActiveObject()[e]=parseInt(t),n.$canvas.getActiveObject().type){case"image":$("#image-settings #object-x-position").val(n.$canvas.getActiveObject().left),$("#image-settings #object-y-position").val(n.$canvas.getActiveObject().top);break;case"shape":case"path-group":$(".shape-settings #object-x-position").val(n.$canvas.getActiveObject().left),$(".shape-settings #object-y-position").val(n.$canvas.getActiveObject().top)}n.$canvas.renderAll()},canvaApp.prototype.manageSearch=function(a,e,t,n,o,s){var i=this;$(".loading-container").removeClass("hidden"),$.ajax({url:globalarr.site_url+"/wp-json/get-pixabay-images/get",type:"get",data:{search_type:a,search_string:e,current_page:s},success:function(e,s){var e=JSON.parse(e);$(".loading-container").addClass("hidden"),parseInt(e.totalHits)>0?($(n).addClass("hidden"),$.each(e.hits,function(e,n){var s="background"==a?n.fullHDURL:n.webformatURL,i='<a href="#" class="thumbnail" data-image="'+s+'"><img src="'+n.previewURL+'" alt="bg" /></a>';$(o).append(i),$(t+" .search-container .fa-long-arrow-left").removeClass("hidden")})):console.log("No hits")},error:function(a,e,t){console.log(a),console.log("Details: "+e+"\nError:"+t)}})},canvaApp.prototype.manageMask=function(a){var e=this;fabric.Image.fromURL(a,function(a){a.width=200,a.height=200,a.left=e.$canvas.getActiveObject().left,a.top=e.$canvas.getActiveObject().top,e.$canvas.add(a),e.$canvas.sendBackwards(a),e.$canvas.getActiveObject().globalCompositeOperation="source-atop",e.$canvas.renderAll()})},canvaApp.prototype.snapObjects=function(a){a.target.set({left:Math.round(a.target.left/grid)*grid,top:Math.round(a.target.top/grid)*grid})},canvaApp.prototype.showGrid=function(a){grid=a;for(var e=this,t=0;t<e.$canvas.width/grid;t++)e.$canvas.add(new fabric.Line([0,t*grid,e.$canvas.width,t*grid],{stroke:"#ccc",selectable:!1,id:"grid-line"}));for(var t=0;t<e.$canvas.width/grid;t++)e.$canvas.add(new fabric.Line([t*grid,0,t*grid,e.$canvas.height],{stroke:"#ccc",selectable:!1,id:"grid-line"}))},canvaApp.prototype.hideGrid=function(){var a=this;a.$canvas.forEachObject(function(e,t){"grid-line"==e.id&&a.$canvas.item(t).remove()}),a.$canvas.renderAll()},canvaApp.prototype.loadShapes=function(){$(".shapes-list .mCSB_container").html(""),$(".loading-container").removeClass("hidden"),$.ajax({url:globalarr.site_url+"/wp-json/get-shapes/get",type:"GET",success:function(a){$(".loading-container").addClass("hidden"),jQuery.each(jQuery.parseJSON(a).data,function(a,e){var t='<a href="#" class="thumbnail shape" title="'+e.title+'" data-id="'+e.id+'" data-image="'+e.guid+'"><img src="'+e.guid+'" alt="'+e.title+'" /></a>';$(".shapes-list .mCSB_container").append(t),$(".shapes-list").mCustomScrollbar("update")})}})},canvaApp.prototype.loadEffects=function(){$(".effects-list .mCSB_container").html(""),$(".loading-container").removeClass("hidden"),$.ajax({url:globalarr.site_url+"/wp-json/get-effects/get",type:"GET",success:function(a){$(".loading-container").addClass("hidden"),jQuery.each(jQuery.parseJSON(a).data,function(a,e){var t='<a href="#" class="thumbnail effects" title="'+e.title+'" data-id="'+e.id+'" data-image="'+e.guid+'"><img src="'+e.guid+'" alt="'+e.title+'" /></a>';$(".effects-list .mCSB_container").append(t),$(".effects-list").mCustomScrollbar("update")})}})},canvaApp.prototype.loadThemes=function(){var a=this;$(".themes-list .mCSB_container").html(""),$.ajax({url:globalarr.site_url+"/wp-json/get-themes/get",type:"get",success:function(e,t){var e=JSON.parse(e),n=$.grep(e.data,function(e,t){return e.width==a.$canvas.width&&e.height==a.$canvas.height});jQuery.each(n,function(a,e){var t='<a href="#" class="thumbnail theme" title="'+e.title+'" data-id="'+e.theme_id+'"><img src="'+e.image+'" alt="'+e.tag+'" /></a>';$(".themes-list .mCSB_container").append(t),$(".themes-list").mCustomScrollbar("update")})},error:function(a,e,t){}})},canvaApp.prototype.loadProjects=function(a){$(a+" .mCSB_container").html(""),$(".loading-container").removeClass("hidden"),$.ajax({url:globalarr.site_url+"/wp-json/get-projects/post",type:"post",data:{user_id:globalarr.user_id,user_key:globalarr.user_key},success:function(e,t){$(".loading-container").addClass("hidden");var e=JSON.parse(e);jQuery.each(e.data,function(e,t){var n='<a href="#" class="thumbnail myproject" title="'+t.title+'" data-projectuser="'+t.project_user+'" data-id="'+t.project_id+'"><img src="'+t.image+'" alt="'+t.tag+'" /></a>';$(a+" .mCSB_container").append(n),$(a).mCustomScrollbar("update")}),$(a).mCustomScrollbar({callbacks:{onScroll:function(){console.log("Content scrolled...")}}})},error:function(a,e,t){console.log(a)}})},canvaApp.prototype.getTheme=function(a){var e=this,e=this;$(".loading-container").removeClass("hidden"),$.ajax({url:globalarr.site_url+"/wp-json/get-theme/get",type:"get",data:{theme_id:a},success:function(a,t){var a=JSON.parse(a);jQuery.each(a,function(a,t){e.$canvas.loadFromJSON(t.json_object,function(){e.$canvas.renderAll(),$(".loading-container").addClass("hidden")})})}})},canvaApp.prototype.saveProject=function(){var a=this,e=Array("width","height","orig_src","clip_left","clip_top","clip_width","clip_height","is_frame","id","gradientAngle"),t=JSON.stringify(a.$canvas.toJSON(e)),n=a.$canvas.toDataURL("image/jpeg");$.ajax({url:globalarr.site_url+"/wp-json/save-project/post",type:"post",data:{user_id:globalarr.user_id,user_key:globalarr.user_key,project_name:$("#projectName").val(),project_width:a.$canvas.width,project_height:a.$canvas.height,project_tag:$("#projectTag").val(),project_image:n,json_object:JSON.stringify(a.$canvas),type:"test",project_id:projectID},success:function(a,e){$(".loading-container").addClass("hidden")},error:function(a,e,t){console.log(t)}})},canvaApp.prototype.getProject=function(){var a=this;a.$canvas.clear(),$(".loading-container").removeClass("hidden"),$.ajax({url:globalarr.site_url+"/wp-json/get-project/post",type:"post",data:{user_id:globalarr.user_id,user_key:globalarr.user_key,project_id:projectID},success:function(e,t){var e=JSON.parse(e),n=e.data.json_object.replace(/\\/g,"");a.$canvas.loadFromJSON(n,function(){a.$canvas.renderAll()}),$(".loading-container").addClass("hidden")}})},canvaApp.prototype.updateTheme=function(){var a=this,e=a.$canvas.toDataURL("image/png");$(".loading-container").removeClass("hidden"),$.ajax({url:"api.php?rquest=updateTheme",type:"POST",data:{json_object:JSON.stringify(a.$canvas),width:a.$canvas.width,height:a.$canvas.height,theme_name:"Test Theme1",tag:"New Year",thumbnail:e,theme_id:selectedThemeId},success:function(a){$(".loading-container").addClass("hidden")}})},canvaApp.prototype.loadSelectedShape=function(a){var e=this;fabric.loadSVGFromURL(a,function(a,t){var n=fabric.util.groupSVGElements(a,t);e.$canvas.add(n).centerObject(n).renderAll(),n.setCoords()}),e.$canvas.renderAll()},Array.prototype.getDuplicates=function(){for(var a={},e=0;e<this.length;e++)a.hasOwnProperty(this[e])?a[this[e]].push(e):this.lastIndexOf(this[e])!==e&&(a[this[e]]=[e]);return a},canvaApp.prototype.showShapeSettings=function(a){var e=this,t=e.$canvas.getActiveObject()||e.$canvas.getActiveGroup(),n=new Array;for(var o in t.paths)t.paths.hasOwnProperty(o)&&""!=t.paths[o].fill&&n.push(t.paths[o].fill);var s=n.getDuplicates(),i=[],c=[];for(r=0;r<n.length;r++)i.indexOf(n[r])===-1&&(i.push(n[r]),c.push(r));$(".shape-colors").html("");for(var r=0;r<i.length;r++)void 0!=s[i[r]]?$(".shape-colors").append('<div class="shape-color" data-group="'+s[i[r]]+'" data-old-color="'+i[r]+'" data-new-color=""><div style="background:'+i[r]+'" class="shape-color-preview" ></div><i class="fa fa-caret-down"></i></div>'):$(".shape-colors").append('<div class="shape-color" data-group="'+c[r]+'" data-old-color="'+i[r]+'" data-new-color=""><div style="background:'+i[r]+'" class="shape-color-preview" ></div><i class="fa fa-caret-down"></i></div>');$(".settings-panel").addClass("hidden"),$(".tab-pane").addClass("hidden"),$(".shape-edit-panel").removeClass("hidden"),$(".shape-colors").find(".shape-color").colorpicker({container:!0,align:"left"}).on("changeColor",function(a){var n=$(this).attr("data-group").split(",");for(var o in n)if(n.hasOwnProperty(o)){var s=parseInt(n[o]);t.paths[s].fill=a.color.toHex()}$(this).find(".shape-color-preview").css("background",a.color.toHex()),e.$canvas.renderAll()}),e.$canvas.renderAll()},canvaApp.prototype.loadTheme=function(a){var e=this;e.$canvas.loadFromJSON(a,function(){e.$canvas.renderAll()})},canvaApp.prototype.saveCanvasAsImage=function(a){var e=this;if("bookCover"!=projectType){var t=e.$canvas.getActiveObject();t&&(t.hasBorders=t.hasControls=!1),e.$canvas.renderAll();var n=e.$canvas.toDataURL({format:a,quality:1}),o=e.dataURItoBlob(n,"image/"+a);saveAs(o,"canvas."+a)}else{var s=e.$canvasFrontCover.getActiveObject();s&&(s.hasBorders=s.hasControls=!1),e.$canvasFrontCover.renderAll();var i=e.$canvasFrontCover.toDataURL({format:a,quality:1}),c=e.$canvasSpine.toDataURL({format:a,quality:1}),r=e.$canvasBackCover.toDataURL({format:a,quality:1}),l=document.getElementById("canvasFrontCover"),d=document.getElementById("canvasSpine"),h=document.getElementById("canvasBackCover"),g=document.createElement("canvas"),v=g.getContext("2d");g.width=1300,g.height=750,v.drawImage(h,0,0),v.drawImage(d,500,0),v.drawImage(l,600,0);var n=g.toDataURL({format:a,quality:1}),o=e.dataURItoBlob(n,"image/"+a);saveAs(o,"canvas."+a)}},canvaApp.prototype.dataURItoBlob=function(a,e){for(var t=atob(a.split(",")[1]),n=new ArrayBuffer(t.length),o=new Uint8Array(n),s=0;s<t.length;s++)o[s]=t.charCodeAt(s);return new Blob([n],{type:e})},canvaApp.prototype.loadContentOnScroll=function(a){var e=this;switch(a){case"shapes-list":break;case"images-list":var t=parseInt($(".search-images-list").attr("data-page"));t+=1,$(".search-images-list").attr("data-page",t),e.manageSearch("images",$("#images .search-container .search-key").val(),"#images",".masonry",".search-images-list",t);break;case"backgrounds-list":var t=parseInt($(".search-backgrounds-list").attr("data-page"));t+=1,$(".search-backgrounds-list").attr("data-page",t),e.manageSearch("background",$("#backgrounds .search-container .search-key").val(),"#backgrounds",".backgrounds-list",".search-backgrounds-list",t)}}});